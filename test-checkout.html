<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Checkout</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .container { max-width: 500px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
        #card-element { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Test Payment - $50</h2>
        <form id="payment-form">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" value="test@example.com" required>
            </div>
            <div class="form-group">
                <label>Card Details</label>
                <div id="card-element"></div>
                <div id="card-errors"></div>
            </div>
            <button type="submit" id="submit-btn">Pay $50</button>
        </form>
    </div>
<script>
// Initialize Stripe
const stripe = Stripe('pk_test_51SVrdkI5ZgmVWT41uD0pyAmezWPatgG98PIrM3P7hyEuXmAhoct3M3ETwxv3Y1wXhZaSiePShG6brJoF3vf4NzFb00fc1MM6If');

let elements;
let cardElement;

// Initialize Stripe Elements
function initializeStripeElements() {
    if (elements) {
        // Already initialized
        return;
    }
    
    elements = stripe.elements();
    
    const style = {
        base: {
            color: '#32325d',
            fontFamily: '"Inter", sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: '#aab7c4'
            }
        },
        invalid: {
            color: '#fa755a',
            iconColor: '#fa755a'
        }
    };
    
    // Create card element
    cardElement = elements.create('card', { 
        style: style,
        hidePostalCode: true
    });
    
    // Mount card element to the container
    const cardElementContainer = document.getElementById('card-element-container');
    if (cardElementContainer) {
        cardElement.mount('#card-element-container');
    }
    
    // Handle real-time validation errors
    cardElement.on('change', ({error}) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
            displayError.textContent = error.message;
        } else {
            displayError.textContent = '';
        }
    });
}

// Handle form submission
document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;
    
    try {
        // Get form data
        const selectedPackage = document.querySelector('.package-option.selected');
        const isCryptoPayment = document.querySelector('.payment-tab[data-method="crypto"]').classList.contains('active');
        
        // Validation
        if (!selectedPackage) {
            alert('Please select a package');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        // Check if required fields are filled
        const requiredFields = ['name', 'email', 'phone', 'vin', 'zip', 'country'];
        for (let field of requiredFields) {
            const fieldElement = document.getElementById(field);
            if (!fieldElement.value.trim()) {
                alert(`Please fill in the ${field.replace('-', ' ')} field`);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }
        }
        
        // For crypto payments, show message
        if (isCryptoPayment) {
            alert('Crypto payment selected. In a real implementation, you would integrate with a crypto payment processor.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        // Calculate total amount (in cents for Stripe)
        const totalAmount = parseFloat(document.getElementById('total-amount').textContent.replace(/[^\d.-]/g, ''));
        const amountInCents = Math.round(totalAmount * 100);
        
        if (amountInCents <= 0) {
            alert('Invalid amount. Please check your order.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        // Prepare metadata
        const metadata = {
            customer_name: document.getElementById('name').value,
            customer_email: document.getElementById('email').value,
            customer_phone: document.getElementById('phone').value,
            vin_number: document.getElementById('vin').value,
            zip_code: document.getElementById('zip').value,
            country: document.getElementById('country').value,
            report_type: document.querySelector('.report-type-btn.active').getAttribute('data-type'),
            package_type: selectedPackage.getAttribute('data-package'),
            package_price: selectedPackage.getAttribute('data-price'),
            payment_method: 'card'
        };
        
        console.log('Creating payment intent with amount:', amountInCents);
        
        // Create payment intent
        const response = await fetch('create-payment-intent.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: amountInCents,
                currency: document.getElementById('currency-selector').value.toLowerCase(),
                metadata: metadata
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        const { clientSecret, paymentIntentId } = result;
        
        if (!clientSecret) {
            throw new Error('No client secret received from server');
        }
        
        console.log('Confirming payment with client secret');
        
        // Confirm payment with Stripe
        const { error } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                },
            },
            return_url: `${window.location.origin}/payment-success.php?payment_intent=${paymentIntentId}`,
        });
        
        if (error) {
            console.error('Stripe error:', error);
            alert('Payment failed: ' + error.message);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        // If successful, the user will be redirected to the return_url
        
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Initialize Stripe Elements when card payment tab is active
document.querySelector('.payment-tab[data-method="card"]').addEventListener('click', function() {
    setTimeout(initializeStripeElements, 100);
});

// Initialize on page load if card payment is active
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.payment-tab[data-method="card"]').classList.contains('active')) {
        setTimeout(initializeStripeElements, 1000);
    }
});
</script>
</body>
</html> 